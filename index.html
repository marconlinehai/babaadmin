<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bill Info Fetch with Excel Export</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      padding: 20px;
    }
    .box {
      background: white;
      padding: 20px;
      border-radius: 10px;
      max-width: 600px;
      margin: auto;
      box-shadow: 0 0 10px #ddd;
    }
    input, button {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      background: black;
      color: white;
      cursor: pointer;
      border: none;
    }
    button:hover {
      background: #333;
    }
    .export-btn {
      background: #28a745;
      margin-top: 10px;
    }
    .export-btn:hover {
      background: #218838;
    }
    .debug-btn {
      background: #ffc107;
      color: black;
      margin-top: 10px;
    }
    .result-box {
      background: #fff;
      padding: 15px;
      margin-top: 15px;
      border-radius: 8px;
      white-space: pre-wrap;
      font-size: 15px;
      border-left: 4px solid #000;
      display: none;
    }
    .debug-box {
      background: #fff3cd;
      padding: 15px;
      margin-top: 15px;
      border-radius: 8px;
      white-space: pre-wrap;
      font-size: 14px;
      border-left: 4px solid #ffc107;
      display: none;
    }
    .loading {
      color: #666;
      font-style: italic;
    }
  </style>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>

<div class="box">
  <h2>Search Bill Details</h2>

  <input id="consumer" type="text" placeholder="Enter Consumer Number">
  <button onclick="fetchBill()">Get Bill Info</button>
  <button class="debug-btn" onclick="showDebugInfo()" id="debugBtn" style="display:none;">Show All Fields</button>
  <button class="export-btn" onclick="exportToExcel()" id="exportBtn" style="display:none;">Export to Excel</button>

  <div id="result" class="result-box"></div>
  <div id="debug" class="debug-box"></div>
</div>

<script>
// Global variable to store bill data
let currentBillData = null;

function fetchBill() {
  const consumer = document.getElementById("consumer").value.trim();
  const resultBox = document.getElementById("result");
  const exportBtn = document.getElementById("exportBtn");
  const debugBtn = document.getElementById("debugBtn");
  const debugBox = document.getElementById("debug");

  if (!consumer) {
    alert("Please enter Consumer Number!");
    return;
  }

  const apiURL = `https://heybrox7562.anayomuswork.workers.dev/api/search-bill/${consumer}`;

  resultBox.style.display = "block";
  debugBox.style.display = "none";
  resultBox.innerHTML = "Loading bill details...";
  resultBox.className = "result-box loading";
  exportBtn.style.display = "none";
  debugBtn.style.display = "none";

  fetch(apiURL)
    .then(res => {
      if (!res.ok) {
        throw new Error('Network response was not ok');
      }
      return res.json();
    })
    .then(data => {
      console.log("Full API Response:", data);
      
      // Store data for Excel export
      currentBillData = data;
      
      let finalText = "";

      // Main information
      finalText += "=== BILL INFORMATION ===\n\n";
      finalText += `Status: ${data.status || 'N/A'}\n`;
      finalText += `Bill Number: ${data.bill_number || 'N/A'}\n`;
      finalText += `Timestamp: ${data.timestamp || 'N/A'}\n`;

      // Handle nested data structure
      if (data.data && data.data.d) {
        finalText += "\n=== BILL DETAILS ===\n\n";
        
        const details = data.data.d;
        
        // Display all fields from the d object
        for (let key in details) {
          if (details.hasOwnProperty(key)) {
            finalText += `${key}: ${details[key]}\n`;
          }
        }
      } else {
        finalText += "\nNo detailed bill information available.\n";
      }

      resultBox.innerHTML = finalText;
      resultBox.className = "result-box";
      exportBtn.style.display = "block";
      debugBtn.style.display = "block";
      
      // Show debug info
      showDebugInfo();
    })
    .catch(err => {
      console.error("Error:", err);
      resultBox.innerHTML = "Error fetching data! Please check:\n- Internet connection\n- Consumer number\n- Try again later";
      resultBox.className = "result-box";
      exportBtn.style.display = "none";
      debugBtn.style.display = "none";
    });
}

function showDebugInfo() {
  if (!currentBillData) return;
  
  const debugBox = document.getElementById("debug");
  let debugText = "=== ALL AVAILABLE FIELDS ===\n\n";
  
  debugText += "Main Data Fields:\n";
  for (let key in currentBillData) {
    if (currentBillData.hasOwnProperty(key) && key !== "data") {
      debugText += `ðŸ“Œ ${key}: ${currentBillData[key]}\n`;
    }
  }
  
  if (currentBillData.data && currentBillData.data.d) {
    debugText += "\nData.d Fields:\n";
    const details = currentBillData.data.d;
    for (let key in details) {
      if (details.hasOwnProperty(key)) {
        debugText += `âœ… ${key}: ${details[key]}\n`;
      }
    }
  }
  
  debugBox.innerHTML = debugText;
  debugBox.style.display = "block";
}

function exportToExcel() {
  if (!currentBillData) {
    alert("No data to export!");
    return;
  }

  try {
    // Prepare data for Excel - ONLY 3 COLUMNS
    const excelData = [];
    
    // Extract data from API response
    const details = currentBillData.data?.d || {};
    
    // Find actual field names by checking all possibilities
    const name = findField(details, [
      'consumerName', 'name', 'customerName', 'accountName', 
      'ConsumerName', 'Name', 'CustomerName', 'consumer_name'
    ]);
    
    const mobile = findField(details, [
      'mobileNo', 'mobile', 'phone', 'contactNo', 'phoneNumber',
      'MobileNo', 'Mobile', 'Phone', 'ContactNo', 'mobile_number',
      'contact', 'Contact', 'phone_no'
    ]);
    
    const consumerNo = document.getElementById("consumer").value.trim();
    
    const rowData = {
      'Name': name,
      'Consumer No': consumerNo,
      'Mobile Number': mobile
    };
    
    excelData.push(rowData);
    
    // Create worksheet
    const ws = XLSX.utils.json_to_sheet(excelData);
    
    // Create workbook
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Bill Data");
    
    // Generate Excel file and download
    const fileName = `Bill_Data_${consumerNo}.xlsx`;
    
    XLSX.writeFile(wb, fileName);
    
    alert(`Data exported successfully!\n\nName: ${name}\nMobile: ${mobile}`);
    
  } catch (error) {
    console.error("Export error:", error);
    alert("Error exporting to Excel: " + error.message);
  }
}

// Helper function to find fields
function findField(details, possibleNames) {
  for (let name of possibleNames) {
    if (details[name] !== undefined && details[name] !== null && details[name] !== '') {
      return details[name];
    }
  }
  return 'Not Available';
}

// Enter key support
document.getElementById("consumer").addEventListener("keypress", function(event) {
  if (event.key === "Enter") {
    fetchBill();
  }
});
</script>

</body>
</html>