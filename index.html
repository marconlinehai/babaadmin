<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bulk Bill Data Export</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      padding: 20px;
    }
    .box {
      background: white;
      padding: 20px;
      border-radius: 10px;
      max-width: 800px;
      margin: auto;
      box-shadow: 0 0 10px #ddd;
    }
    textarea, input, button {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    textarea {
      height: 150px;
      resize: vertical;
    }
    button {
      background: black;
      color: white;
      cursor: pointer;
      border: none;
    }
    button:hover {
      background: #333;
    }
    .export-btn {
      background: #28a745;
    }
    .export-btn:hover {
      background: #218838;
    }
    .bulk-btn {
      background: #007bff;
    }
    .bulk-btn:hover {
      background: #0056b3;
    }
    .debug-btn {
      background: #ffc107;
      color: black;
    }
    .progress-container {
      margin: 15px 0;
      background: #f8f9fa;
      border-radius: 5px;
      padding: 10px;
    }
    .progress-bar {
      height: 20px;
      background: #007bff;
      border-radius: 10px;
      width: 0%;
      transition: width 0.3s;
    }
    .status {
      margin-top: 10px;
      font-size: 14px;
      color: #666;
    }
    .result-box {
      background: #fff;
      padding: 15px;
      margin-top: 15px;
      border-radius: 8px;
      white-space: pre-wrap;
      font-size: 14px;
      border-left: 4px solid #000;
      display: none;
    }
    .debug-box {
      background: #fff3cd;
      padding: 15px;
      margin-top: 15px;
      border-radius: 8px;
      white-space: pre-wrap;
      font-size: 12px;
      border-left: 4px solid #ffc107;
      display: none;
    }
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .button-group button {
      flex: 1;
    }
  </style>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>

<div class="box">
  <h2>Bulk Bill Data Export (Up to 500 Consumers)</h2>

  <h3>Single Search</h3>
  <input id="consumer" type="text" placeholder="Enter Single Consumer Number">
  <div class="button-group">
    <button onclick="fetchSingleBill()">Get Single Bill Info</button>
    <button class="debug-btn" onclick="showSingleDebug()" id="singleDebugBtn" style="display:none;">Debug Fields</button>
  </div>

  <h3>Bulk Search</h3>
  <textarea id="bulkConsumers" placeholder="Enter multiple Consumer Numbers (one per line)&#10;Example:&#10;2000279857&#10;2000279858&#10;2000279859"></textarea>
  
  <div class="button-group">
    <button class="bulk-btn" onclick="startBulkProcessing()">Process Bulk Data</button>
    <button class="export-btn" onclick="exportBulkToExcel()" id="bulkExportBtn" style="display:none;">Export All to Excel</button>
    <button class="debug-btn" onclick="showBulkDebug()" id="bulkDebugBtn" style="display:none;">Show Field Map</button>
  </div>

  <div class="progress-container">
    <div class="progress-bar" id="progressBar"></div>
    <div class="status" id="progressStatus">Ready</div>
  </div>

  <div id="singleResult" class="result-box"></div>
  <div id="singleDebug" class="debug-box"></div>
  <div id="bulkResult" class="result-box"></div>
  <div id="bulkDebug" class="debug-box"></div>
</div>

<script>
// Global variables
let currentBillData = null;
let bulkData = [];
let processedCount = 0;
let totalCount = 0;
let fieldMap = {};

// Single bill fetch
function fetchSingleBill() {
  const consumer = document.getElementById("consumer").value.trim();
  const resultBox = document.getElementById("singleResult");
  const debugBtn = document.getElementById("singleDebugBtn");

  if (!consumer) {
    alert("Please enter Consumer Number!");
    return;
  }

  const apiURL = `https://heybrox7562.anayomuswork.workers.dev/api/search-bill/${consumer}`;

  resultBox.style.display = "block";
  resultBox.innerHTML = "Loading bill details...";
  debugBtn.style.display = "none";

  fetch(apiURL)
    .then(res => res.json())
    .then(data => {
      currentBillData = data;
      displaySingleResult(data, consumer, resultBox);
      debugBtn.style.display = "block";
    })
    .catch(err => {
      resultBox.innerHTML = "Error fetching data!";
    });
}

function displaySingleResult(data, consumer, resultBox) {
  let finalText = "=== BILL INFORMATION ===\n\n";
  finalText += `Consumer Number: ${consumer}\n`;
  finalText += `Status: ${data.status || 'N/A'}\n`;
  finalText += `Bill Number: ${data.bill_number || 'N/A'}\n`;

  if (data.data && data.data.d) {
    const details = data.data.d;
    finalText += "\n=== BILL DETAILS ===\n\n";
    for (let key in details) {
      if (details.hasOwnProperty(key)) {
        finalText += `${key}: ${details[key]}\n`;
      }
    }
  }

  resultBox.innerHTML = finalText;
}

function showSingleDebug() {
  if (!currentBillData) return;
  
  const debugBox = document.getElementById("singleDebug");
  let debugText = "=== DEBUG FIELD INFORMATION ===\n\n";
  
  debugText += "Looking for Name and Mobile fields...\n\n";
  
  if (currentBillData.data && currentBillData.data.d) {
    const details = currentBillData.data.d;
    debugText += "Available fields in data.d:\n";
    
    let foundName = false;
    let foundMobile = false;
    
    for (let key in details) {
      debugText += `ðŸ” ${key}: ${details[key]}\n`;
      
      // Check for name fields
      if (key.toLowerCase().includes('name') && !foundName) {
        debugText += `   âœ… POTENTIAL NAME FIELD: ${key}\n`;
        fieldMap.name = key;
        foundName = true;
      }
      
      // Check for mobile fields
      if ((key.toLowerCase().includes('mobile') || key.toLowerCase().includes('phone')) && !foundMobile) {
        debugText += `   âœ… POTENTIAL MOBILE FIELD: ${key}\n`;
        fieldMap.mobile = key;
        foundMobile = true;
      }
    }
    
    if (!foundName) {
      debugText += "\nâŒ No name field found. Available fields:\n";
      for (let key in details) {
        debugText += `   - ${key}\n`;
      }
    }
    
    if (!foundMobile) {
      debugText += "\nâŒ No mobile field found. Available fields:\n";
      for (let key in details) {
        debugText += `   - ${key}\n`;
      }
    }
  }
  
  debugBox.innerHTML = debugText;
  debugBox.style.display = "block";
}

// Bulk processing functions
function startBulkProcessing() {
  const consumerText = document.getElementById("bulkConsumers").value.trim();
  const bulkResultBox = document.getElementById("bulkResult");
  const exportBtn = document.getElementById("bulkExportBtn");
  const debugBtn = document.getElementById("bulkDebugBtn");

  if (!consumerText) {
    alert("Please enter Consumer Numbers!");
    return;
  }

  const consumers = consumerText.split('\n')
    .map(c => c.trim())
    .filter(c => c.length > 0);

  if (consumers.length > 500) {
    alert(`Maximum 500 consumers allowed. You entered ${consumers.length}`);
    return;
  }

  totalCount = consumers.length;
  processedCount = 0;
  bulkData = [];
  fieldMap = {};
  
  bulkResultBox.style.display = "block";
  bulkResultBox.innerHTML = `Starting bulk processing for ${totalCount} consumers...\n\n`;
  exportBtn.style.display = "none";
  debugBtn.style.display = "none";

  updateProgress(0, `Starting... (0/${totalCount})`);

  // Process consumers one by one with delay to avoid rate limiting
  processNextConsumer(consumers, 0);
}

function processNextConsumer(consumers, index) {
  if (index >= consumers.length) {
    bulkProcessingComplete();
    return;
  }

  const consumer = consumers[index];
  const apiURL = `https://heybrox7562.anayomuswork.workers.dev/api/search-bill/${consumer}`;

  fetch(apiURL)
    .then(res => res.json())
    .then(data => {
      processedCount++;
      
      // Extract data with smart field detection
      const details = data.data?.d || {};
      
      // Auto-detect fields on first successful response
      if (processedCount === 1 && details) {
        autoDetectFields(details);
      }
      
      const name = extractField(details, 'name');
      const mobile = extractField(details, 'mobile');
      
      // Store in bulk data array
      bulkData.push({
        'Name': name,
        'Consumer No': consumer,
        'Mobile Number': mobile,
        'Bill Number': data.bill_number || 'N/A',
        'Status': data.status || 'N/A',
        'Raw Data': JSON.stringify(details) // For debugging
      });

      // Update progress
      const progress = Math.round((processedCount / totalCount) * 100);
      updateProgress(progress, `Processed: ${processedCount}/${totalCount} - ${consumer}`);

      // Update results
      updateBulkResults();

      // Process next consumer after delay
      setTimeout(() => {
        processNextConsumer(consumers, index + 1);
      }, 500);

    })
    .catch(err => {
      processedCount++;
      
      // Store error data
      bulkData.push({
        'Name': 'Error',
        'Consumer No': consumer,
        'Mobile Number': 'Fetch Failed',
        'Bill Number': 'N/A',
        'Status': 'Error'
      });

      const progress = Math.round((processedCount / totalCount) * 100);
      updateProgress(progress, `Error: ${processedCount}/${totalCount} - ${consumer}`);
      updateBulkResults();

      // Continue with next consumer
      setTimeout(() => {
        processNextConsumer(consumers, index + 1);
      }, 500);
    });
}

function autoDetectFields(details) {
  // Auto-detect name field
  for (let key in details) {
    if (key.toLowerCase().includes('name')) {
      fieldMap.name = key;
      break;
    }
  }
  
  // Auto-detect mobile field
  for (let key in details) {
    if (key.toLowerCase().includes('mobile') || key.toLowerCase().includes('phone')) {
      fieldMap.mobile = key;
      break;
    }
  }
  
  console.log("Auto-detected field map:", fieldMap);
}

function extractField(details, fieldType) {
  if (fieldMap[fieldType]) {
    return details[fieldMap[fieldType]] || 'Not Available';
  }
  
  // Fallback to manual search
  const searchTerms = fieldType === 'name' 
    ? ['name', 'consumerName', 'customerName', 'accountName']
    : ['mobile', 'phone', 'mobileNo', 'phoneNumber', 'contactNo'];
  
  for (let term of searchTerms) {
    if (details[term] !== undefined && details[term] !== null && details[term] !== '') {
      return details[term];
    }
  }
  
  return 'Not Available';
}

function updateProgress(progress, status) {
  document.getElementById('progressBar').style.width = progress + '%';
  document.getElementById('progressStatus').textContent = status;
}

function updateBulkResults() {
  const bulkResultBox = document.getElementById("bulkResult");
  let resultText = `Bulk Processing: ${processedCount}/${totalCount} completed\n\n`;
  resultText += "Field Mapping: ";
  resultText += `Name: ${fieldMap.name || 'Not found'}, `;
  resultText += `Mobile: ${fieldMap.mobile || 'Not found'}\n\n`;
  resultText += "Recent entries:\n";
  
  const recentEntries = bulkData.slice(-5);
  recentEntries.forEach(entry => {
    resultText += `âœ“ ${entry['Consumer No']}: ${entry['Name']} - ${entry['Mobile Number']}\n`;
  });
  
  if (processedCount === totalCount) {
    resultText += `\nâœ… Processing complete! ${bulkData.length} records collected.`;
  }
  
  bulkResultBox.innerHTML = resultText;
}

function showBulkDebug() {
  const debugBox = document.getElementById("bulkDebug");
  let debugText = "=== BULK FIELD ANALYSIS ===\n\n";
  
  debugText += `Detected Field Map:\n`;
  debugText += `Name Field: ${fieldMap.name || 'Not detected'}\n`;
  debugText += `Mobile Field: ${fieldMap.mobile || 'Not detected'}\n\n`;
  
  debugText += "Sample Data:\n";
  const sampleData = bulkData.slice(0, 3);
  sampleData.forEach((item, index) => {
    debugText += `\nSample ${index + 1}:\n`;
    debugText += `Consumer: ${item['Consumer No']}\n`;
    debugText += `Name: ${item['Name']}\n`;
    debugText += `Mobile: ${item['Mobile Number']}\n`;
    debugText += `Raw: ${item['Raw Data']}\n`;
  });
  
  debugBox.innerHTML = debugText;
  debugBox.style.display = "block";
}

function bulkProcessingComplete() {
  const exportBtn = document.getElementById("bulkExportBtn");
  const debugBtn = document.getElementById("bulkDebugBtn");
  
  exportBtn.style.display = "block";
  debugBtn.style.display = "block";
  updateProgress(100, `Complete! ${totalCount} consumers processed`);
  
  const successful = bulkData.filter(item => item.Status !== 'Error').length;
  const failed = bulkData.filter(item => item.Status === 'Error').length;
  
  alert(`Bulk processing complete!\n\nSuccessful: ${successful}\nFailed: ${failed}\nTotal: ${totalCount}\n\nCheck field mapping before export.`);
}

function exportBulkToExcel() {
  if (bulkData.length === 0) {
    alert("No data to export!");
    return;
  }

  try {
    // Remove raw data before export
    const exportData = bulkData.map(item => {
      const { RawData, ...cleanItem } = item;
      return cleanItem;
    });
    
    const ws = XLSX.utils.json_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Bulk Bill Data");
    
    const fileName = `Bulk_Bill_Data_${new Date().getTime()}.xlsx`;
    XLSX.writeFile(wb, fileName);
    
    alert(`Exported ${bulkData.length} records to Excel successfully!`);
    
  } catch (error) {
    console.error("Export error:", error);
    alert("Error exporting to Excel: " + error.message);
  }
}

// Enter key support
document.getElementById("consumer").addEventListener("keypress", function(event) {
  if (event.key === "Enter") {
    fetchSingleBill();
  }
});
</script>

</body>
</html>