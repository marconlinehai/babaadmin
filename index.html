<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bill Info Fetch with Excel Export</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      padding: 20px;
    }
    .box {
      background: white;
      padding: 20px;
      border-radius: 10px;
      max-width: 700px;
      margin: auto;
      box-shadow: 0 0 10px #ddd;
    }
    input, button {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      background: black;
      color: white;
      cursor: pointer;
      border: none;
    }
    button:hover {
      background: #333;
    }
    .export-btn {
      background: #28a745;
      margin-top: 10px;
    }
    .export-btn:hover {
      background: #218838;
    }
    .result-box {
      background: #fff;
      padding: 15px;
      margin-top: 15px;
      border-radius: 8px;
      white-space: pre-wrap;
      font-size: 15px;
      border-left: 4px solid #000;
      display: none;
    }
    .loading {
      color: #666;
      font-style: italic;
    }
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .button-group button {
      flex: 1;
    }
    .debug-info {
      background: #fff3cd;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      border-left: 4px solid #ffc107;
      font-size: 14px;
    }
  </style>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>

<div class="box">
  <h2>Search Bill Details with Excel Export</h2>

  <input id="consumer" type="text" placeholder="Enter Consumer Number">
  
  <div class="button-group">
    <button onclick="fetchBill()">Get Bill Info</button>
    <button class="export-btn" onclick="exportToExcel()" id="exportBtn" style="display:none;">Export to Excel</button>
    <button class="export-btn" onclick="showDebugInfo()" id="debugBtn" style="display:none; background: #ffc107; color: black;">Debug Data</button>
  </div>

  <div id="debug" class="debug-info" style="display:none;"></div>
  <div id="result" class="result-box"></div>
</div>

<script>
// Global variable to store bill data
let currentBillData = null;

function fetchBill() {
  const consumer = document.getElementById("consumer").value.trim();
  const resultBox = document.getElementById("result");
  const exportBtn = document.getElementById("exportBtn");
  const debugBtn = document.getElementById("debugBtn");
  const debugDiv = document.getElementById("debug");

  if (!consumer) {
    alert("Please enter Consumer Number!");
    return;
  }

  const apiURL = `https://heybrox7562.anayomuswork.workers.dev/api/search-bill/${consumer}`;

  resultBox.style.display = "block";
  debugDiv.style.display = "none";
  resultBox.innerHTML = "Loading bill details...";
  resultBox.className = "result-box loading";
  exportBtn.style.display = "none";
  debugBtn.style.display = "none";

  fetch(apiURL)
    .then(res => {
      if (!res.ok) {
        throw new Error('Network response was not ok');
      }
      return res.json();
    })
    .then(data => {
      console.log("Full API Response:", data);
      
      // Store data for Excel export
      currentBillData = data;
      
      let finalText = "";

      // Main information
      finalText += "=== BILL INFORMATION ===\n\n";
      finalText += `Status: ${data.status || 'N/A'}\n`;
      finalText += `Bill Number: ${data.bill_number || 'N/A'}\n`;
      finalText += `Timestamp: ${data.timestamp || 'N/A'}\n`;

      // Handle nested data structure
      if (data.data && data.data.d) {
        finalText += "\n=== BILL DETAILS ===\n\n";
        
        const details = data.data.d;
        
        // Display all fields from the d object
        for (let key in details) {
          if (details.hasOwnProperty(key)) {
            finalText += `${key}: ${details[key]}\n`;
          }
        }
      } else {
        finalText += "\nNo detailed bill information available.\n";
      }

      resultBox.innerHTML = finalText;
      resultBox.className = "result-box";
      exportBtn.style.display = "block";
      debugBtn.style.display = "block";
      
      // Show available fields for debugging
      showAvailableFields(data);
    })
    .catch(err => {
      console.error("Error:", err);
      resultBox.innerHTML = "Error fetching data! Please check:\n- Internet connection\n- Consumer number\n- Try again later";
      resultBox.className = "result-box";
      exportBtn.style.display = "none";
      debugBtn.style.display = "none";
    });
}

function showAvailableFields(data) {
  const debugDiv = document.getElementById("debug");
  let debugInfo = "=== AVAILABLE FIELDS ===\n\n";
  
  debugInfo += "Top Level Fields:\n";
  for (let key in data) {
    if (data.hasOwnProperty(key)) {
      debugInfo += `- ${key}: ${typeof data[key]}\n`;
    }
  }
  
  if (data.data && data.data.d) {
    debugInfo += "\nData.d Fields:\n";
    const details = data.data.d;
    for (let key in details) {
      if (details.hasOwnProperty(key)) {
        debugInfo += `- ${key}: ${details[key]} (${typeof details[key]})\n`;
      }
    }
  }
  
  debugDiv.innerHTML = "<pre>" + debugInfo + "</pre>";
}

function showDebugInfo() {
  const debugDiv = document.getElementById("debug");
  debugDiv.style.display = debugDiv.style.display === "none" ? "block" : "none";
}

function exportToExcel() {
  if (!currentBillData) {
    alert("No data to export!");
    return;
  }

  try {
    // Prepare data for Excel
    const excelData = [];
    
    // Extract data from API response
    const details = currentBillData.data?.d || {};
    
    // Map actual API fields to our column names
    const rowData = {
      'Consumer_No': document.getElementById("consumer").value.trim(),
      'Contract_Ac': details.contractNo || details.contractAccount || details.accountNo || 'N/A',
      'Name': details.consumerName || details.name || details.customerName || 'N/A',
      'Mobile': details.mobileNo || details.mobile || details.phone || details.contactNo || 'N/A',
      'Email': details.email || details.emailId || 'N/A',
      'Bill_No': currentBillData.bill_number || details.billNo || 'N/A',
      'Bill_Date': details.billDate || details.billingDate || currentBillData.timestamp || 'N/A',
      'Amount': details.amount || details.billAmount || details.totalAmount || 'N/A',
      'Due_Date': details.dueDate || details.paymentDueDate || 'N/A',
      'Status': currentBillData.status || 'N/A',
      'Address': details.address || details.consumerAddress || 'N/A'
    };
    
    excelData.push(rowData);
    
    // Create worksheet
    const ws = XLSX.utils.json_to_sheet(excelData);
    
    // Create workbook
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Bill Data");
    
    // Generate Excel file and download
    const consumerNo = document.getElementById("consumer").value.trim();
    const fileName = `Bill_Data_${consumerNo}_${new Date().getTime()}.xlsx`;
    
    XLSX.writeFile(wb, fileName);
    
    alert("Data exported to Excel successfully!");
    
  } catch (error) {
    console.error("Export error:", error);
    alert("Error exporting to Excel: " + error.message);
  }
}

// Smart export function that tries to find correct fields
function smartExportToExcel() {
  if (!currentBillData) {
    alert("No data to export!");
    return;
  }

  try {
    const details = currentBillData.data?.d || {};
    
    // Find actual field names by searching common patterns
    const fieldMap = {
      'Consumer_No': findField(details, ['consumerNo', 'consumerNumber', 'customerNo', 'consumerId']),
      'Contract_Ac': findField(details, ['contractNo', 'contractAccount', 'accountNo', 'accountNumber']),
      'Name': findField(details, ['consumerName', 'name', 'customerName', 'accountName']),
      'Mobile': findField(details, ['mobileNo', 'mobile', 'phone', 'contactNo', 'phoneNumber']),
      'Email': findField(details, ['email', 'emailId', 'customerEmail']),
      'Bill_No': currentBillData.bill_number || findField(details, ['billNo', 'billNumber']),
      'Bill_Date': findField(details, ['billDate', 'billingDate', 'invoiceDate']),
      'Amount': findField(details, ['amount', 'billAmount', 'totalAmount', 'dueAmount']),
      'Due_Date': findField(details, ['dueDate', 'paymentDueDate', 'lastDate']),
      'Address': findField(details, ['address', 'consumerAddress', 'customerAddress'])
    };

    const excelData = [fieldMap];
    
    // Create worksheet
    const ws = XLSX.utils.json_to_sheet(excelData);
    
    // Create workbook
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Bill Data");
    
    const consumerNo = document.getElementById("consumer").value.trim();
    const fileName = `Bill_Data_${consumerNo}_${new Date().getTime()}.xlsx`;
    
    XLSX.writeFile(wb, fileName);
    
    alert("Data exported to Excel successfully!");
    
  } catch (error) {
    console.error("Export error:", error);
    alert("Error exporting to Excel: " + error.message);
  }
}

// Helper function to find fields
function findField(details, possibleNames) {
  for (let name of possibleNames) {
    if (details[name] !== undefined) {
      return details[name];
    }
  }
  return 'N/A';
}

// Enter key support
document.getElementById("consumer").addEventListener("keypress", function(event) {
  if (event.key === "Enter") {
    fetchBill();
  }
});

// Replace export function with smart version
document.getElementById("exportBtn").onclick = smartExportToExcel;
</script>

</body>
</html>